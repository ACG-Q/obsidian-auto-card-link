name: Release Obsidian Plugin

on:
  push:
    tags:
      - "v*"

env:
  PLUGIN_NAME: auto-card-link
  BUILD_DIR: dist

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Log checkout info
        env:
          GIT_LOG: ${{ github.event.head_commit.message }}
        run: |
          echo "â„¹ï¸ æ­£åœ¨æ£€å‡ºä»£ç åº“..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "è§¦å‘æäº¤: $GITHUB_SHA"
          echo "æäº¤ä¿¡æ¯: $GIT_LOG"
          echo "æ ‡ç­¾ç‰ˆæœ¬: $GITHUB_REF_NAME"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"
          
      - name: Log Node.js info
        run: |
          echo "âœ… Node.js ç¯å¢ƒå·²é…ç½®"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          node -v
          npm -v

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ æ­£åœ¨å®‰è£…é¡¹ç›®ä¾èµ–..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          npm ci --prefer-offline
          echo "å·²å®‰è£…ä¾èµ–é¡¹:"
          npm list --depth=0

      - name: Set Version
        run: |
          echo "â„¹ï¸ æ­£åœ¨è®¾ç½®ç‰ˆæœ¬å·..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "å½“å‰ç‰ˆæœ¬å·: ${{ github.ref_name }}"
          npm version ${{ github.ref_name }} --no-git-tag-version
          npm run version

      - name: Build project
        run: |
          echo "ğŸ—ï¸ å¼€å§‹æ„å»ºé¡¹ç›®..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          npm run build

      - name: Package artifacts
        id: package
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          OUTPUT_DIR="${{ env.BUILD_DIR }}/${{ env.PLUGIN_NAME }}"
          
          echo "ğŸ“¦ æ‰“åŒ…ç‰ˆæœ¬: v$VERSION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "è¾“å‡ºç›®å½•: $OUTPUT_DIR"
          
          mkdir -p $OUTPUT_DIR
          echo "å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶..."
          cp -v {main.js,manifest.json,styles.css} $OUTPUT_DIR
          
          echo "æœ€ç»ˆæ‰“åŒ…å†…å®¹:"
          tree $OUTPUT_DIR
          
          cd ${{ env.BUILD_DIR }}
          echo "æ­£åœ¨åˆ›å»º ZIP åŒ…..."
          zip -r ${{ env.PLUGIN_NAME }}-$VERSION.zip ${{ env.PLUGIN_NAME }}
          
          echo "ç”Ÿæˆå…ƒæ•°æ®:"
          echo "zip_name=${{ env.PLUGIN_NAME }}-$VERSION.zip" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          echo "ğŸ“¦ åŒ…æ–‡ä»¶ä¿¡æ¯:"
          ls -lh ${{ env.PLUGIN_NAME }}-*.zip

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "v${{ steps.package.outputs.version }}"
          body: "Auto-generated release for version ${{ steps.package.outputs.version }}"
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
          files: |
            ${{ env.BUILD_DIR }}/${{ steps.package.outputs.zip_name }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Log release info
        run: |
          echo "ğŸš€ æ­£åœ¨åˆ›å»ºå‘å¸ƒ..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "å‘å¸ƒç‰ˆæœ¬: v${{ steps.package.outputs.version }}"
          echo "åŒ…æ–‡ä»¶è·¯å¾„: ${{ env.BUILD_DIR }}/${{ steps.package.outputs.zip_name }}"
          echo "é¢„å‘å¸ƒæ ‡è®°: ${{ contains(github.ref, '-') }}"

      - name: Log release status
        if: success()
        run: |
          echo "âœ… å‘å¸ƒæˆåŠŸå®Œæˆ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "æœ€ç»ˆç‰ˆæœ¬å·: v${{ steps.package.outputs.version }}"
          echo "åŒ…æ–‡ä»¶åç§°: ${{ steps.package.outputs.zip_name }}"
          echo "æ–‡ä»¶å¤§å°: $(du -h ${{ env.BUILD_DIR }}/${{ steps.package.outputs.zip_name }} | cut -f1)"
          echo "å‘å¸ƒæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S %Z')"
    
      - name: Commit changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add manifest.json versions.json package.json
          git commit -m "chore: update version to ${{ github.ref_name }}"
          git push origin HEAD:main